# PWA из того же репозитория (без отдельного клона)

Один репозиторий, один код. React Native + Expo уже умеет веб: используется `react-native-web`, тот же JSX и логика.

## Не нужен второй репозиторий

Пересобирать проект «под PWA» в отдельном клоне не нужно. Отдельный репозиторий с «полным клоном под PWA» означал бы второй стек (React для веба), дублирование экранов и API, два кода для поддержки. Здесь всё остаётся в одном месте.

## Что уже есть

- В проекте подключены `react-native-web` и скрипт `npm run web` (expo start --web).
- В `app.json` в блоке `expo.web` добавлены поля для PWA: `name`, `shortName`, `themeColor`, `backgroundColor`, `display: "standalone"`, `startUrl`. Это нужно для манифеста и «Добавить на экран».

## Как протестировать PWA без своего сервера

Сервер уже есть: это dev-сервер Expo. Его достаточно для проверки.

**На компе (Chrome / Safari):**
1. В корне проекта: `npm run web`.
2. В терминале появится ссылка, например `http://localhost:8081` или `http://localhost:19006`. Открой её в браузере.
3. Приложение откроется. **localhost** браузер считает «безопасным», поэтому манифест и установка PWA работают:
   - **Chrome:** в адресной строке может появиться иконка «Установить» или в меню (⋮) → «Установить СтройнаЯ…». После установки откроется отдельное окно без адресной строки (standalone).
   - **Safari (macOS):** можно проверить, что приложение грузится; «Добавить на рабочий стол» в Safari тоже работает для localhost.

**На телефоне в той же Wi‑Fi сети:**
1. Узнай IP компа в сети: `ifconfig` (раздел en0 или «Wi‑Fi»), например `192.168.1.105`.
2. На телефоне открой в браузере: `http://192.168.1.105:8081` (порт смотри в терминале после `npm run web`).
3. **Android (Chrome):** может предложить «Добавить на главный экран».
4. **iPhone (Safari):** «Добавить на экран „Домой“» иногда доступно только по **HTTPS**. Если по HTTP пункта нет, для проверки на iOS используй туннель с HTTPS (см. ниже).

**Если на iPhone нужен именно «Добавить на экран» (HTTPS):**
- Запусти туннель на свой localhost, например: `npx ngrok http 8081` (или `npx localtunnel --port 8081`). Получишь ссылку вида `https://xxxx.ngrok.io`.
- Открой эту ссылку на iPhone в Safari → «Поделиться» → «На экран „Домой“».

Итого: свой сервер не нужен, хватает `npm run web` и при необходимости туннеля для HTTPS на телефоне.

## Как пользоваться

1. **Локально (веб)**  
   `npm run web` — откроется браузер с тем же приложением.

2. **Сборка статики для хоста**  
   `npx expo export --platform web` — в каталоге `dist/` (или как укажет Expo) будет готовый вывод. Его нужно отдать на хостинг по HTTPS (обязательно для PWA на iOS).

3. **Выложить на stroynaya.online**  
   Содержимое этой сборки залить в корень сайта или в подкаталог (например, `/app`). Главное: сайт должен работать по **https**, и у манифеста должен быть полный URL (при необходимости поправить `startUrl` в `app.json` под свой домен).

4. **Установка на iPhone без App Store**  
   Пользователь открывает https://stroynaya.online (или твой URL приложения) в **Safari**, нажимает «Поделиться» → «На экран „Домой“». Иконка появится на главном экране, при запуске откроется приложение без адресной строки (режим standalone). Оплачивать Apple Developer не нужно.

## Ограничения веба/PWA по сравнению с нативным iOS

- Нет публикации в App Store (приложение только через «Добавить на экран»).
- Push-уведомления и доступ к части возможностей устройства могут отличаться от нативного приложения.
- Часть нативных модулей (например, отдельные плагины Expo/RN) в веб-сборке не работают — такие места нужно оборачивать в `Platform.OS === 'web'` или отключать для веба.

## Service worker: когда нужен, когда нет

**Без service worker уже работает:**
- «Добавить на экран Домой» и запуск в standalone (без адресной строки).
- Манифест из `app.json` (иконка, название, тема).

**Service worker нужен, если хочешь:**
- **Офлайн:** открытие приложения и части экранов без интернета (кэш JS, CSS, статика).
- **Быстрый повторный заход:** кэширование бандла и ассетов, меньше загрузки с сервера.
- **Фоновая синхронизация / push** (на вебе возможности скромнее, чем в нативном приложении).

Для «просто иконка на главном экране и открытие как приложение» service worker не обязателен. Подключать его имеет смысл, когда нужен офлайн или кэш.

**Как добавить (если понадобится):**
- Expo при `expo export --platform web` может не подключать service worker по умолчанию. Варианты:
  1. **Кастомный webpack:** в конфиге веб-сборки подключить Workbox (или другой генератор SW), регистрировать SW в точке входа веб-приложения.
  2. **Отдельный SW-файл:** написать `sw.js` (или сгенерировать через Workbox), положить в `public/`, при сборке копировать в корень вывода и в коде вызывать `navigator.serviceWorker.register('/sw.js')` при загрузке приложения (только на платформе `web`).
  3. **Документация Expo:** [Progressive Web Apps](https://docs.expo.dev/guides/progressive-web-apps), [enabling-web-service-workers](https://github.com/expo/fyi/blob/main/enabling-web-service-workers.md) — там описаны актуальные шаги под твою версию Expo.

Итог: для минимального PWA (иконка + standalone) сервис-воркер не нужен; для офлайна и кэша — нужен, подключается отдельно (Workbox или свой `sw.js` + регистрация в коде).

## Почему на iOS всё ещё видна строка с URL (как в браузере)

Если при открытии с главного экрана отображается адресная строка или нижняя панель Safari, iOS создал **ярлык вкладки**, а не standalone PWA. Так бывает, когда Safari в момент «Добавить на экран Домой» не успел или не смог загрузить манифест ([Habr](https://habr.com/ru/articles/989862/), [pwadev.ru](https://pwadev.ru/learn/pwa/enhancements/#ios-ipados)).

**Что сделано в проекте:**
- В `public/manifest.json` заданы `scope: "/"`, `start_url: "/"`, `display: "standalone"`. Все внутренние ссылки должны оставаться в пределах этого scope.
- Создан **`public/index.html`** (кастомный шаблон для веба): в нём уже в **начальном HTML** прописаны `<link rel="manifest" href="/manifest.json">`, `apple-mobile-web-app-capable`, `apple-mobile-web-app-status-bar-style` и `apple-mobile-web-app-title`. Safari при «Добавить на экран» видит их сразу, без ожидания JS, и создаёт именно standalone PWA, а не ярлык вкладки. Дополнительно те же теги по-прежнему подставляются из `index.js` на случай, если кастомный index не используется.

**Что сделать тебе:**
1. Удалить старую иконку с главного экрана (долгое нажатие → удалить).
2. Открыть приложение в Safari по туннелю (tuna и т.п.), убедиться, что страница полностью загрузилась.
3. Снова «Поделиться» → «На экран Домой» и установить заново.
4. Открывать только тапом по новой иконке. Не открывать тот же URL в Safari.

Если строка всё равно остаётся, проверь на компе в браузере: открой `https://твой-туннель/manifest.json` и убедись, что отдаётся JSON с `display: "standalone"`. Если манифест не отдаётся (404), при экспорте веба (`npx expo export --platform web`) положи `public/manifest.json` в корень вывода и настрой хостинг так, чтобы он отдавал его по пути `/manifest.json`.
